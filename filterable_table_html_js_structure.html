<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filterable Table – Operators, Column Visibility, Value Selection</title>
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #14161a;
      --panel-2: #1b1f24;
      --text: #e8eef3;
      --muted: #a8b3bd;
      --accent: #3da9fc;
      --border: #2a2f36;
      --ring: #7cc4ff80;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b0c10 0%, #0e1116 100%);
      color: var(--text);
    }
    .container { max-width: 1100px; margin: 28px auto; padding: 0 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,.35); }
    .card-hd { display: flex; gap: 12px; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--border); }
    .title { font-size: 18px; font-weight: 650; letter-spacing: .2px; }

    .toolbar { display: flex; gap: 8px; align-items: center; }
    button, select, input[type="text"] {
      background: var(--panel-2); color: var(--text); border: 1px solid var(--border);
      border-radius: 10px; padding: 8px 10px; font-size: 14px; line-height: 1; outline: none;
    }
    button { cursor: pointer; }
    button:hover { border-color: #374151; }
    button:focus, select:focus, input:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--accent); }

    .table-wrap { overflow: auto; border-radius: 0 0 16px 16px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { position: sticky; top: 0; background: #12151a; z-index: 1; text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    tbody td { padding: 10px 12px; border-top: 1px solid var(--border); white-space: nowrap; }
    tbody tr:hover { background: #121822; }

    .th-inner { display: inline-flex; gap: 6px; align-items: center; }
    .icon { font-style: normal; opacity: .8; }

    /* Menus */
    .menu { position: absolute; background: var(--panel-2); border: 1px solid var(--border); border-radius: 12px; padding: 8px; display: none; min-width: 260px; box-shadow: 0 24px 48px rgba(0,0,0,.5); }
    .menu.open { display: block; }
    .menu .row { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .menu .row-inline { display: flex; gap: 8px; }
    .menu .muted { color: var(--muted); font-size: 12px; }
    .menu .list { max-height: 260px; overflow: auto; border: 1px solid var(--border); border-radius: 10px; }
    .menu label { display: flex; gap: 10px; align-items: center; padding: 8px 10px; border-bottom: 1px solid var(--border); }
    .menu label:last-child { border-bottom: 0; }
    .menu .actions { display: flex; justify-content: flex-end; gap: 8px; }
    .chip { background: #0f1720; border: 1px solid var(--border); border-radius: 999px; padding: 4px 8px; font-size: 12px; color: var(--muted); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); background: #0f1318; color: var(--muted); }

    .empty { color: var(--muted); padding: 24px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="card">
      <div class="card-hd">
        <div class="title">Charges (example data)</div>
        <div class="toolbar">
          <button id="btn-columns" title="Show/Hide columns" aria-haspopup="menu" aria-controls="menu-columns">☰ Columns</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="grid" aria-describedby="grid-caption">
          <caption id="grid-caption" style="display:none">Filterable table with per‑column operators, checkbox value selection, and a column visibility menu</caption>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Column value filter menu (reused for any column) -->
  <div class="menu" id="menu-filter" role="menu" aria-hidden="true">
    <div class="row">
      <div class="muted">Filter <span id="filter-col-name" class="chip"></span></div>
      <div class="row-inline">
        <select id="op-select" aria-label="Operator">
          <option value="contains">Contains</option>
          <option value="notcontains">Not contains</option>
          <option value="equals">Equals</option>
          <option value="notequal">Not equal</option>
          <option value="startswith">Starts with</option>
          <option value="endswith">Ends with</option>
        </select>
        <input id="op-value" type="text" placeholder="Value" />
      </div>
      <div class="actions">
        <button id="btn-clear-filter">Clear</button>
        <button id="btn-apply-filter">Apply</button>
      </div>

      <div class="muted" style="margin-top:8px">or pick specific values</div>
      <input id="value-search" type="text" placeholder="Filter values…" />
      <div id="value-list" class="list" role="group" aria-label="Distinct values"></div>
      <div class="actions">
        <button id="btn-value-show-all">Show all</button>
        <button id="btn-value-hide-all">Hide all</button>
      </div>
      <div class="muted">Tip: press <span class="kbd">Enter</span> to apply</div>
    </div>
  </div>

  <!-- Column visibility menu -->
  <div class="menu" id="menu-columns" role="menu" aria-hidden="true">
    <div class="row">
      <input id="col-search" type="text" placeholder="Filter…" />
      <div id="col-list" class="list" role="group" aria-label="Columns"></div>
      <div class="actions">
        <button id="btn-show-all">Show all</button>
        <button id="btn-hide-all">Hide all</button>
      </div>
    </div>
  </div>

  <script>
    // ----- Example data -----
    const data = [
      { date: '2025-08-01', publisher: 'Microsoft', chargeType: 'Usage', family: 'AI + Machine Learning', service: 'Cognitive Services', meter: 'gpt-4o-mini input', part: 'A1-001', cost: 12.34 },
      { date: '2025-08-01', publisher: 'Microsoft', chargeType: 'Usage', family: 'Compute', service: 'Virtual Machines', meter: 'B-series vCPU', part: 'B1-200', cost: 8.10 },
      { date: '2025-08-02', publisher: 'Third‑Party', chargeType: 'Usage', family: 'Security', service: 'Defender for Cloud', meter: 'Server node', part: 'D4-900', cost: 2.50 },
      { date: '2025-08-03', publisher: 'Microsoft', chargeType: 'Usage', family: 'Storage', service: 'Blob Storage', meter: 'Hot LRS', part: 'S2-300', cost: 1.12 },
      { date: '2025-08-04', publisher: 'Microsoft', chargeType: 'Usage', family: 'AI + Machine Learning', service: 'Azure AI Foundry', meter: 'Prompt Tokens', part: 'A1-777', cost: 19.99 }
    ];

    // Column definitions (order matters)
    const columns = [
      { key: 'date',        name: 'Date' },
      { key: 'publisher',   name: 'Publisher type' },
      { key: 'chargeType',  name: 'Charge type' },
      { key: 'family',      name: 'Service Family' },
      { key: 'service',     name: 'Service name' },
      { key: 'meter',       name: 'Meter' },
      { key: 'part',        name: 'Part Number' },
      { key: 'cost',        name: 'Cost', format: (v)=> typeof v === 'number' ? v.toFixed(2) : v }
    ];

    // State
    const state = {
      visible: Object.fromEntries(columns.map(c => [c.key, true])),
      filters: {}, // { key: { op, value } }
      valueSelections: {} // { key: Set([...allowedValuesAsStrings]) }
    };

    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');

    // Render header with per-column filter buttons
    function renderHeader() {
      thead.innerHTML = '';
      const tr = document.createElement('tr');
      for (const col of columns) {
        if (!state.visible[col.key]) continue;
        const th = document.createElement('th');
        const wrap = document.createElement('span');
        wrap.className = 'th-inner';
        wrap.innerHTML = `<span>${col.name}</span>`;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-filter';
        btn.innerHTML = '<i class="icon">⛃</i>'; // funnel-like icon
        btn.title = `Filter ${col.name}`;
        btn.addEventListener('click', (e) => openFilterMenu(e.currentTarget, col));
        wrap.appendChild(btn);

        // Show active chip
        const f = state.filters[col.key];
        const s = state.valueSelections[col.key];
        if ((f && f.value) || (s && s.size !== getDistinctValues(col.key).length)) {
          const chip = document.createElement('span');
          chip.className = 'chip';
          let piece = [];
          if (f && f.value) piece.push(`${f.op} \"${f.value}\"`);
          if (s) piece.push(`${s.size} selected`);
          chip.textContent = piece.join(' · ');
          wrap.appendChild(chip);
        }

        th.appendChild(wrap);
        tr.appendChild(th);
      }
      thead.appendChild(tr);
    }

    // Render rows according to filters and visibility
    function renderRows() {
      const rows = data.filter(row => rowPassesFilters(row));
      tbody.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = Object.values(state.visible).filter(Boolean).length || 1;
        td.className = 'empty';
        td.textContent = 'No rows match the current filters';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }
      for (const row of rows) {
        const tr = document.createElement('tr');
        for (const col of columns) {
          if (!state.visible[col.key]) continue;
          const td = document.createElement('td');
          const v = row[col.key];
          td.textContent = col.format ? col.format(v) : v;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function applyOp(cell, op, val) {
      const c = (cell ?? '').toString().toLowerCase();
      const v = (val ?? '').toString().toLowerCase();
      switch (op) {
        case 'contains': return c.includes(v);
        case 'notcontains': return !c.includes(v);
        case 'equals': return c === v;
        case 'notequal': return c !== v;
        case 'startswith': return c.startsWith(v);
        case 'endswith': return c.endsWith(v);
        default: return true;
      }
    }

    function rowPassesFilters(row) {
      // operator filters
      for (const [key, f] of Object.entries(state.filters)) {
        if (!f || f.value === '' || f.value == null) continue;
        if (!applyOp(row[key], f.op, f.value)) return false;
      }
      // value selections (if defined, they constrain results; empty set => show none)
      for (const [key, set] of Object.entries(state.valueSelections)) {
        if (set === undefined) continue;
        const val = (row[key] ?? '').toString();
        if (!set.has(val)) return false;
      }
      return true;
    }

    // ---------- Filter menu logic ----------
    const menuFilter = document.getElementById('menu-filter');
    const opSelect = document.getElementById('op-select');
    const opValue = document.getElementById('op-value');
    const filterColName = document.getElementById('filter-col-name');
    const valueSearch = document.getElementById('value-search');
    const valueList = document.getElementById('value-list');
    const btnValueShowAll = document.getElementById('btn-value-show-all');
    const btnValueHideAll = document.getElementById('btn-value-hide-all');
    let currentFilterCol = null; // column object

    function openFilterMenu(anchor, col) {
      currentFilterCol = col;
      filterColName.textContent = col.name;
      const f = state.filters[col.key] || { op: 'contains', value: '' };
      opSelect.value = f.op; opValue.value = f.value ?? '';
      positionMenu(anchor, menuFilter);
      menuFilter.classList.add('open');
      menuFilter.setAttribute('aria-hidden', 'false');
      setTimeout(() => opValue.focus(), 0);
      // build checkbox value list for the column
      buildValueList(col, valueSearch.value || '');
    }

    function closeMenus() {
      for (const m of document.querySelectorAll('.menu')) {
        m.classList.remove('open'); m.setAttribute('aria-hidden', 'true');
      }
    }

    document.getElementById('btn-apply-filter').addEventListener('click', () => {
      if (!currentFilterCol) return;
      state.filters[currentFilterCol.key] = { op: opSelect.value, value: opValue.value };
      closeMenus(); renderHeader(); renderRows();
    });

    document.getElementById('btn-clear-filter').addEventListener('click', () => {
      if (!currentFilterCol) return;
      delete state.filters[currentFilterCol.key];
      delete state.valueSelections[currentFilterCol.key];
      opValue.value = ''; closeMenus(); renderHeader(); renderRows();
    });

    opValue.addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('btn-apply-filter').click();
    });

    // ----- Value checkbox list helpers -----
    function getDistinctValues(key) {
      const set = new Set();
      for (const r of data) set.add((r[key] ?? '').toString());
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }
    function buildValueList(col, query='') {
      const values = getDistinctValues(col.key);
      const q = (query||'').toLowerCase();
      valueList.innerHTML = '';
      const selected = state.valueSelections[col.key] ?? new Set(values); // default show all
      for (const v of values) {
        if (q && !v.toLowerCase().includes(q)) continue;
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = v;
        cb.checked = selected.has(v);
        cb.addEventListener('change', () => {
          const set = state.valueSelections[col.key] ?? new Set(values);
          if (cb.checked) set.add(v); else set.delete(v);
          state.valueSelections[col.key] = set;
          renderRows();
        });
        const txt = document.createElement('span'); txt.textContent = v || '(empty)';
        label.append(cb, txt); valueList.appendChild(label);
      }
      valueSearch.oninput = (e)=> buildValueList(col, e.target.value);
      btnValueShowAll.onclick = ()=>{
        state.valueSelections[col.key] = new Set(getDistinctValues(col.key));
        buildValueList(col, valueSearch.value||''); renderRows();
      };
      btnValueHideAll.onclick = ()=>{
        state.valueSelections[col.key] = new Set();
        buildValueList(col, valueSearch.value||''); renderRows();
      };
    }

    // ---------- Column visibility menu ----------
    const btnColumns = document.getElementById('btn-columns');
    const menuColumns = document.getElementById('menu-columns');
    const colSearch = document.getElementById('col-search');
    const colList = document.getElementById('col-list');

    btnColumns.addEventListener('click', (e) => {
      buildColumnList();
      positionMenu(e.currentTarget, menuColumns);
      menuColumns.classList.add('open'); menuColumns.setAttribute('aria-hidden', 'false');
      setTimeout(()=> colSearch.focus(), 0);
    });

    function buildColumnList(filter = '') {
      colList.innerHTML = '';
      const q = filter.toLowerCase();
      for (const col of columns) {
        if (q && !col.name.toLowerCase().includes(q)) continue;
        const id = `col-${col.key}`;
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.checked = !!state.visible[col.key];
        cb.id = id; cb.addEventListener('change', () => {
          state.visible[col.key] = cb.checked; renderHeader(); renderRows();
        });
        const txt = document.createElement('span'); txt.textContent = col.name;
        label.append(cb, txt); colList.appendChild(label);
      }
    }

    colSearch.addEventListener('input', (e) => buildColumnList(e.target.value));

    document.getElementById('btn-show-all').addEventListener('click', () => {
      for (const c of columns) state.visible[c.key] = true; renderHeader(); renderRows();
    });
    document.getElementById('btn-hide-all').addEventListener('click', () => {
      for (const c of columns) state.visible[c.key] = false; renderHeader(); renderRows();
    });

    // ---------- Utilities ----------
    function positionMenu(anchor, menu) {
      const rect = anchor.getBoundingClientRect();
      const bodyRect = document.body.getBoundingClientRect();
      const top = rect.bottom + window.scrollY + 6;
      const left = Math.min(rect.left + window.scrollX, bodyRect.width - menu.offsetWidth - 12);
      menu.style.top = `${top}px`; menu.style.left = `${left}px`;
    }

    document.addEventListener('click', (e) => {
      const anyMenu = e.target.closest('.menu');
      const anyBtn = e.target.closest('button');
      if (!anyMenu && !anyBtn) closeMenus();
    });

    // Initial paint
    renderHeader();
    renderRows();

    // -----------------------------
    // Minimal tests (console only)
    // -----------------------------
    (function runTests(){
      console.assert(applyOp('Azure','contains','zur') === true, 'contains should match');
      console.assert(applyOp('Azure','notcontains','foo') === true, 'notcontains should match');
      console.assert(applyOp('abc','equals','ABC') === true, 'equals should be case-insensitive');
      console.assert(getDistinctValues('publisher').length === 2, 'distinct publishers should be 2');
      // valueSelections constraint test
      const before = data.filter(rowPassesFilters).length;
      state.valueSelections.publisher = new Set(['Microsoft']);
      const after = data.filter(rowPassesFilters).length;
      console.assert(after <= before && after > 0, 'value selection should restrict rows');
      delete state.valueSelections.publisher;
      console.log('Basic tests passed');
    })();
  </script>
</body>
</html>
