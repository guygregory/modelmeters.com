<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Model Meter Monthly summaries - ‚ú® AI generated (Dynamic)</title>
	<style>
		/* Light theme (default) */
		:root {
			--bg:#f5f7fa; --bg-alt:#e9eef2; --panel:#ffffff; --panel-2:#f0f3f7; --text:#1b242b; --muted:#5d6b76; --accent:#2563eb; --border:#d0d7de; --ring:#3b82f680; --shadow:0 6px 18px rgba(0,0,0,.08);
			--topbar-offset: 0px; /* header not sticky on monthly page */
		}
		/* Dark theme */
		:root[data-theme="dark"] {
			--bg:#0a0e13; --bg-alt:#161c24; --panel:#1c2128; --panel-2:#21272e; --text:#f0f3f6; --muted:#8d96a0; --accent:#4285f4; --border:#3d4449; --ring:#4285f460; --shadow:0 8px 20px rgba(0,0,0,.3);
		}
		* { margin:0; padding:0; box-sizing:border-box; }
		body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; line-height:1.5; color:var(--text); background:var(--bg); }
		.container { max-width:900px; margin:0 auto; padding:20px; }
		.header { display:flex; align-items:center; gap:12px; margin-bottom:24px; padding:16px 20px; background:var(--panel); border-radius:8px; border:1px solid var(--border); box-shadow:var(--shadow); }
		.title { font-size:22px; font-weight:600; color:var(--text); flex:1; }
		.controls { display:flex; gap:8px; align-items:center; }
		button { background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:500; transition:all .2s; }
		button:hover { opacity:.85; transform:translateY(-1px); }
		button.secondary { background:var(--panel-2); color:var(--text); border:1px solid var(--border); }
		button.secondary:hover { background:var(--bg-alt); }
		.article { background:var(--panel); border:1px solid var(--border); border-radius:8px; margin-bottom:16px; box-shadow:var(--shadow); overflow:hidden; transition:all .2s; }
		.article.collapsed .month-details { display:none; }
		.month-title { padding:16px 20px; cursor:pointer; display:flex; align-items:center; gap:12px; background:var(--panel-2); transition:background .2s; user-select:none; }
		.month-title:hover { background:var(--bg-alt); }
		.chev { color:var(--muted); font-size:14px; transition:transform .2s; }
		.article:not(.collapsed) .chev { transform:rotate(90deg); }
		.month-heading { font-size:18px; font-weight:600; color:var(--text); margin:0; }
		.month-details { padding:20px; }
		.footer { text-align:center; padding:16px; color:var(--muted); font-size:14px; margin-top:24px; }

		/* GitHub Markdown styles */
		.markdown-body { color:var(--text); }
		.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6 { margin-top:0; margin-bottom:16px; font-weight:600; line-height:1.25; color:var(--text); }
		.markdown-body h1 { font-size:2em; }
		.markdown-body h2 { font-size:1.5em; }
		.markdown-body h3 { font-size:1.25em; }
		.markdown-body p { margin-top:0; margin-bottom:16px; }
		.markdown-body ul,.markdown-body ol { margin-top:0; margin-bottom:16px; padding-left:2em; }
		.markdown-body li { margin-bottom:4px; }
		.markdown-body code { padding:.2em .4em; background:var(--bg-alt); border-radius:3px; font-size:85%; }
		.markdown-body pre { background:var(--bg-alt); padding:16px; border-radius:6px; overflow-x:auto; margin-bottom:16px; }
		.markdown-body pre code { background:none; padding:0; }
		.markdown-body blockquote { padding:0 1em; color:var(--muted); border-left:4px solid var(--border); margin:0 0 16px; }
		.markdown-body table { border-collapse:collapse; margin-bottom:16px; width:100%; }
		.markdown-body th,.markdown-body td { padding:6px 13px; border:1px solid var(--border); }
		.markdown-body th { background:var(--bg-alt); font-weight:600; }
	</style>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
	<div class="container">
		<div class="header">
			<div class="title">Foundry Models monthly summary AI agent ‚ú®</div>
			<div class="controls">
				<button class="secondary" id="btn-theme">üåô Dark</button>
				<button class="secondary" id="btn-back">‚Üê Back</button>
			</div>
		</div>
		<div id="articles">
			<div id="status" class="footer" style="border:none;">Loading monthly summaries‚Ä¶</div>
		</div>
		<div class="footer">Built from Markdown files in <code>agent/aisummary/</code> at runtime.</div>
	</div>

	<script>
		// Theme support (preserves and allows switching)
		(() => {
			const root = document.documentElement;
			const btn = document.getElementById('btn-theme');

			// Check URL params first, then localStorage, then system preference
			const urlParams = new URLSearchParams(window.location.search);
			const paramTheme = urlParams.get('theme');
			const stored = localStorage.getItem('priceExplorerTheme');
			const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			let mode = (paramTheme || stored || (prefersDark ? 'dark' : 'light')) === 'dark' ? 'dark' : 'light';

			if (paramTheme) localStorage.setItem('priceExplorerTheme', mode);

			function currentMode(){
				return root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
			}

			function applyMode(newMode){
				const m = newMode === 'dark' ? 'dark' : 'light';
				if (m === 'dark') root.setAttribute('data-theme','dark');
				else root.removeAttribute('data-theme');
				localStorage.setItem('priceExplorerTheme', m);
				updateBtn();
			}

			function updateBtn(){
				const m = currentMode();
				// Show target mode on the button (same UX as main page)
				const nextLabel = m === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
				btn.textContent = nextLabel;
				btn.setAttribute('aria-label', 'Switch to ' + (m === 'dark' ? 'light' : 'dark') + ' theme');
			}

			applyMode(mode);
			btn.addEventListener('click', () => {
				const isDark = currentMode() === 'dark';
				applyMode(isDark ? 'light' : 'dark');
			});
		})();

		// Back button
		document.getElementById('btn-back').addEventListener('click', () => {
			window.location.href = '../index.html';
		});

		function getEnsuredBase() {
			const { origin, pathname } = window.location;
			const pathBase = pathname.endsWith('/') ? pathname : pathname + '/';
			return origin + pathBase; // always ends with '/'
		}

		async function listMarkdownFiles(dirUrl) {
			// Strategy:
			// 1) Try directory listing (works locally with Python http.server)
			// 2) Try JSON manifest at aisummary/index.json (array of filenames or {files:[]})
			// 3) Fallback: parse monthly/index.html to get article ids -> map to YYYY-MM-DD.md
			// Return newest-first.

			// Important: when the page is loaded as /agent (no trailing slash),
			// relative fetches like 'aisummary/' would incorrectly resolve to /aisummary/.
			// Build absolute URLs against a base that guarantees a trailing slash.
			const ensuredBase = getEnsuredBase();
			const dirAbs = new URL(dirUrl, ensuredBase).toString();
			// 1) Directory listing
			try {
				const res = await fetch(dirAbs);
				if (res.ok) {
					const html = await res.text();
					const doc = new DOMParser().parseFromString(html, 'text/html');
					const hrefs = Array.from(doc.querySelectorAll('a'))
						.map(a => a.getAttribute('href'))
						.filter(h => h && h.toLowerCase().endsWith('.md'));
					const files = Array.from(new Set(hrefs.map(h => h.split('#')[0].split('?')[0])));
					if (files.length) {
						files.sort((a, b) => b.localeCompare(a));
						return files;
					}
				}
			} catch (_) { /* ignore and try next */ }

			// 2) Manifest
			try {
				const manifestUrl = new URL('index.json', dirAbs);
				const res = await fetch(manifestUrl);
				if (res.ok) {
					const data = await res.json();
					const files = Array.isArray(data) ? data : (data.files || []);
					if (files.length) {
						files.sort((a, b) => b.localeCompare(a));
						return files;
					}
				}
			} catch (_) { /* ignore */ }

			return [];
		}

		function filenameBase(path) {
			const name = path.split('/').pop();
			return name.endsWith('.md') ? name.slice(0, -3) : name;
		}

		function createArticle({ id, title, html, collapsed }) {
			const article = document.createElement('article');
			article.className = 'article' + (collapsed ? ' collapsed' : '');
			article.id = id;

			const header = document.createElement('div');
			header.className = 'month-title';
			header.innerHTML = `<span class="chev">‚ñ∂</span><h2 class="month-heading">${title}</h2>`;
			header.addEventListener('click', () => {
				article.classList.toggle('collapsed');
				history.replaceState(null, '', '#' + id); // keep URL in sync
			});

			const details = document.createElement('div');
			details.className = 'month-details';
			const mdContainer = document.createElement('div');
			mdContainer.className = 'markdown-body';
			mdContainer.innerHTML = html;
			details.appendChild(mdContainer);

			article.appendChild(header);
			article.appendChild(details);
			return article;
		}

		async function loadSummaries() {
			const status = document.getElementById('status');
			const container = document.getElementById('articles');
			try {
				const dir = 'aisummary/';
				const files = await listMarkdownFiles(dir);
				if (!files.length) {
					status.textContent = 'No Markdown files found in aisummary/';
					return;
				}

				// Fetch all markdown files in parallel, skipping any missing ones
				const results = await Promise.allSettled(files.map(async (file) => {
					const ensuredBase = getEnsuredBase();
					const dirAbs = new URL(dir, ensuredBase);
					const url = new URL(file, dirAbs);
					const res = await fetch(url);
					if (!res.ok) throw new Error('Failed to fetch ' + url);
					const text = await res.text();
					// Extract the first H1 for the clickable title
					let title = filenameBase(file);
					const h1Match = text.match(/^#\s*(.+)$/m);
					if (h1Match) title = h1Match[1];

					// Remove the first H1 (and a following blank line, if present) from content to avoid duplicates
					const lines = text.split(/\r?\n/);
					const idx = lines.findIndex(l => /^#\s/.test(l));
					if (idx !== -1) {
						lines.splice(idx, 1);
						if (lines[idx] === '') lines.splice(idx, 1);
					}
					const stripped = lines.join('\n');
					const html = marked.parse(stripped);
					return { file, title, html };
				}));

				const fetched = results.filter(r => r.status === 'fulfilled').map(r => r.value);

				// Clear status and append articles
				if (!fetched.length) {
					status.textContent = 'No Markdown files could be loaded. On Azure Static Web Apps, add aisummary/index.json (list of files) or ensure agent/index.html includes article ids.';
					return;
				}
				status.remove();
				fetched.forEach((item, idx) => {
					const id = filenameBase(item.file);
					const article = createArticle({ id, title: item.title, html: item.html, collapsed: idx !== 0 });
					container.appendChild(article);
				});

				// If there's a hash, expand and scroll
				if (location.hash) {
					const el = document.getElementById(location.hash.slice(1));
					if (el) el.classList.remove('collapsed');
				}
			} catch (err) {
				console.error(err);
				status.textContent = 'Error loading summaries. Ensure directory listing is enabled for aisummary/.';
			}
		}

		// Kick off
		loadSummaries();
	</script>
</body>
</html>